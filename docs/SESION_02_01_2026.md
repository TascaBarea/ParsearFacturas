# ðŸ“‹ SESIÃ“N 02/01/2026 - ParsearFacturas

## ðŸŽ¯ RESUMEN DEL DÃA

| MÃ©trica | Valor |
|---------|-------|
| **MÃ³dulo modificado** | `salidas/excel.py` |
| **VersiÃ³n** | v5.8 |
| **Nueva funcionalidad** | Hoja "Facturas" (cabeceras) |
| **IntegraciÃ³n** | DiccionarioEmisorTitulo.xlsx |

---

## ðŸŒ™ SESIÃ“N NOCHE (v5.8)

### Trabajo realizado

**Nueva hoja "Facturas" en Excel de salida:**

| Columna | DescripciÃ³n | Fuente |
|---------|-------------|--------|
| `#` | NÃºmero gestorÃ­a | Archivo PDF (4 primeros dÃ­gitos) o `TMPxxx` |
| `CUENTA` | CÃ³digo cuenta proveedor | DiccionarioEmisorTitulo.xlsx â†’ Hoja1 |
| `TITULO` | Nombre oficial proveedor | DiccionarioEmisorTitulo.xlsx â†’ Hoja1 |
| `Fec.Fac.` | Fecha factura | DD-MM-YY |
| `REF` | Referencia interna | Del extractor |
| `Total` | Total factura | Del extractor |
| `OBSERVACIONES` | Estado cuadre + notas | OK, DESCUADRE, SIN_LINEAS, SIN_NUM_GESTORIA |

### Estructura Excel actualizada

```
Excel de salida (2 hojas):
â”œâ”€â”€ Lineas      # Detalle artÃ­culos (antes "Facturas") - 843 filas
â””â”€â”€ Facturas    # Cabeceras (NUEVA) - 217 filas (una por factura)
```

### LÃ³gica de bÃºsqueda CUENTA/TITULO

```
Proveedor (extractor)
    â†“
[1] BÃºsqueda exacta en alias (Sheet1)
    â†“ NOMBRE_EN_CONCEPTO â†’ TITULO_FACTURA
[2] BÃºsqueda exacta en cuentas (Hoja1)
    â†“ CLIENTE â†’ CUENTA
[3] BÃºsqueda parcial (contiene)
    â†“
[4] BÃºsqueda por similitud (>60%)
    â†“
[5] No encontrado â†’ CUENTA: "PENDIENTE", TITULO: nombre original
```

### Auto-numeraciÃ³n facturas sin gestorÃ­a

- Archivos sin nÃºmero inicial â†’ `TMP001`, `TMP002`...
- Se aÃ±ade `SIN_NUM_GESTORIA` en OBSERVACIONES
- Ejemplo: `4T25 1001 BENJAMIN ORTEGA...` â†’ `TMP001`

---

## ðŸ“Š RESULTADOS PRUEBA 4T25

| MÃ©trica | Valor |
|---------|-------|
| **Facturas totales** | 217 |
| **Con CUENTA asignada** | 177 (81.6%) |
| **PENDIENTE** | 40 (18.4%) |

### Proveedores PENDIENTE (sin cuenta en diccionario)

| # | Proveedor | Total |
|---|-----------|-------|
| 4001 | ANTHROPIC | 18.00â‚¬ |
| 4005 | YOIGO | 32.00â‚¬ |
| 4024 | COOPERATIVA MONTBRIONE | 314.50â‚¬ |
| 4034 | ALFARERIA ANGEL Y LOLI | 690.55â‚¬ |
| 4069 | FRANCISCO GUERRA | 694.77â‚¬ |
| 4154 | MARITA COSTA | 589.06â‚¬ |
| ... | (34 mÃ¡s) | ... |

### Alias recomendados para aÃ±adir a Sheet1

| NOMBRE_EN_CONCEPTO | TITULO_FACTURA |
|--------------------|----------------|
| MARITA COSTA | COSTA VILELA MARITA |
| VIRGEN DE LA SIERRA | BODEBA VIERGEN DE LA SIERRA S. COOP. |
| FRANCISCO GUERRA | GUERRA OLLER FRANCISCO |
| COOPERATIVA MONTBRIONE | AGRICOLA DE MONTBRIO DEL CAMP SCCL |
| ANTHROPIC | (aÃ±adir a Hoja1 con cuenta nueva) |
| YOIGO | XFERA MOVILES SAU |

---

## ðŸ“ ARCHIVOS GENERADOS

| Archivo | DescripciÃ³n | Estado |
|---------|-------------|--------|
| `excel.py` | MÃ³dulo salidas actualizado v5.8 | **LISTO** |
| `Facturas_4T25_NUEVO.xlsx` | Excel de prueba con 2 hojas | **LISTO** |

---

## ðŸ”§ CAMBIOS TÃ‰CNICOS EN excel.py

### Funciones nuevas

```python
# Carga diccionario de cuentas con cachÃ©
cargar_diccionario_cuentas(ruta) -> (dict_cuentas, dict_alias)

# Busca CUENTA y TITULO de un proveedor
buscar_cuenta_titulo(proveedor, ruta) -> (cuenta, titulo)

# Extrae nÃºmero gestorÃ­a del nombre de archivo
extraer_numero_gestoria(archivo, numero) -> (num, es_temporal)

# Formatea fecha a DD-MM-YY
formatear_fecha_factura(fecha) -> str
```

### Modificaciones a generar_excel()

```python
def generar_excel(facturas, ruta, nombre_hoja='Lineas', ruta_diccionario=None):
    """
    Genera Excel con DOS hojas:
    - "Lineas": Detalle de artÃ­culos (antes "Facturas")
    - "Facturas": Cabeceras (una fila por factura)
    """
```

---

## ðŸ“‹ CHECKLIST DESPLIEGUE

```cmd
# 1. Copiar mÃ³dulo actualizado
copy excel.py C:\_ARCHIVOS\TRABAJO\Facturas\ParsearFacturas-main\salidas\

# 2. Limpiar cachÃ©
cd C:\_ARCHIVOS\TRABAJO\Facturas\ParsearFacturas-main\salidas
rmdir /s /q __pycache__

# 3. Verificar (debe generar Excel con 2 hojas)
cd C:\_ARCHIVOS\TRABAJO\Facturas\ParsearFacturas-main
python main.py -i "C:\...\4 TRI 2025" -o test.xlsx

# 4. Actualizar DiccionarioEmisorTitulo.xlsx
# - AÃ±adir alias faltantes en Sheet1
# - AÃ±adir cuentas nuevas en Hoja1

# 5. Commit
git add .
git commit -m "SesiÃ³n 02/01/2026: v5.8, nueva hoja Facturas (cabeceras), integraciÃ³n cuentas"
git push
```

---

## ðŸŽ¯ PRÃ“XIMA SESIÃ“N - TAREAS PENDIENTES

### Inmediato
- [ ] AÃ±adir alias faltantes a DiccionarioEmisorTitulo.xlsx (Sheet1)
- [ ] AÃ±adir cuentas nuevas a Hoja1 (ANTHROPIC, YOIGO, etc.)
- [ ] Probar con los 4 trimestres

### Proveedores prioritarios (ParsearFacturas)
| Proveedor | Errores | Tipo |
|-----------|---------|------|
| JIMELUZ | 21 | OCR malo |
| DIA/ECOMS | 17 | SIN_LINEAS |
| RETENCIONES | 16 | DESCUADRE |
| MARITA COSTA | 8 | DESCUADRE |
| LAVAPIES 3T | 4 | DESCUADRE especÃ­fico 3T |

---

## ðŸ“ˆ PROGRESO DEL PROYECTO

| Fecha | VersiÃ³n | Cuadre | Cambio |
|-------|---------|--------|--------|
| Inicio | v3.5 | 42% | Baseline |
| 01/01 noche | v5.7 | 66% | LA ROSQUILLERIA, BM |
| **02/01 noche** | **v5.8** | **66%** | **Nueva hoja Facturas** |
| Objetivo | - | **80%** | +14% pendiente |

---

*SesiÃ³n cerrada: 02/01/2026 (noche)*
