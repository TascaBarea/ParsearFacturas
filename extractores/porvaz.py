"""
Extractor para PORVAZ VILAGARCÍA S.L.

Conservas gallegas de Vilagarcía de Arousa (Pontevedra)
CIF: B36281087
IBAN: ES63 0049 5368 0625 1628 3321

Formato factura (pdfplumber):
- Líneas producto: DESCRIPCION CANTIDAD PRECIO IVA IMPORTE
- IVA: 10% (conservas alimenticias)

Variantes nombre: PORVAZ, PORVAZ TITO, PORVAZ VILLAGARCIA, CONSERVAS TITO

Creado: 19/12/2025
"""
from extractores.base import ExtractorBase
from extractores import registrar
from typing import List, Dict, Optional
import re


@registrar('PORVAZ', 'PORVAZ TITO', 'PORVAZ VILLAGARCIA', 'PORVAZ VILAGARCIA', 
           'CONSERVAS TITO', 'TITO CONSERVAS', 'LA RIVIERE')
class ExtractorPorvaz(ExtractorBase):
    """Extractor para facturas de PORVAZ VILAGARCÍA S.L."""
    
    nombre = 'PORVAZ'
    cif = 'B36281087'
    iban = 'ES63 0049 5368 0625 1628 3321'
    metodo_pdf = 'pdfplumber'
    
    def extraer_lineas(self, texto: str) -> List[Dict]:
        """
        Extrae líneas INDIVIDUALES de productos.
        
        Formato:
        DESCRIPCION CANTIDAD PRECIO IVA IMPORTE
        BERBERECHO ENLATADO 40/60 RR120 AL 10 4,500 10,0 45,00
        """
        lineas = []
        
        # Patrón para líneas de producto
        # La descripción puede contener números (40/60, 8/12, etc.)
        # Formato: DESCRIPCION CANTIDAD PRECIO IVA IMPORTE
        # Ejemplo: MEJILLON ESCABECHE 8/12 RR120 AL 20 3,800 10,0 76,00
        
        patron_linea = re.compile(
            r'^([A-ZÁÉÍÓÚÑ][A-ZÁÉÍÓÚÑ0-9/\s]+?)\s+'  # Descripción (empieza con mayúscula)
            r'(\d+)\s+'                               # Cantidad (entero)
            r'(\d+,\d{3})\s+'                         # Precio (X,XXX)
            r'(\d+,\d)\s+'                            # IVA (10,0)
            r'(\d+,\d{2})\s*$'                        # Importe
        , re.MULTILINE)
        
        for match in patron_linea.finditer(texto):
            descripcion = match.group(1).strip()
            cantidad = int(match.group(2))
            precio = self._convertir_europeo(match.group(3))
            iva = int(float(self._convertir_europeo(match.group(4))))
            importe = self._convertir_europeo(match.group(5))
            
            # Filtrar cabeceras y líneas no válidas
            if any(x in descripcion.upper() for x in ['DESCRIPCION', 'CANTIDAD', 'PRECIO', 
                                                       'IMPORTE', 'CLIENTE', 'FACTURA']):
                continue
            
            # Validar que el importe sea razonable
            if importe < 1.0:
                continue
            
            lineas.append({
                'codigo': '',  # PORVAZ no usa códigos
                'articulo': descripcion[:50],
                'cantidad': cantidad,
                'precio_ud': round(precio, 3),
                'iva': iva,
                'base': round(importe, 2)
            })
        
        return lineas
    
    def _convertir_europeo(self, texto: str) -> float:
        """Convierte formato europeo (1.234,56) a float."""
        if not texto:
            return 0.0
        texto = texto.strip()
        if '.' in texto and ',' in texto:
            texto = texto.replace('.', '').replace(',', '.')
        elif ',' in texto:
            texto = texto.replace(',', '.')
        try:
            return float(texto)
        except:
            return 0.0
    
    def extraer_total(self, texto: str) -> Optional[float]:
        """Extrae total de la factura."""
        # Buscar "Total Factura:" seguido del importe
        patron = re.search(
            r'Total\s+Factura:\s*(\d+,\d{2})',
            texto, re.IGNORECASE
        )
        if patron:
            return self._convertir_europeo(patron.group(1))
        return None
    
    def extraer_fecha(self, texto: str) -> Optional[str]:
        """Extrae fecha de la factura."""
        # Formato: Fecha: 14-04-2025
        patron = re.search(r'Fecha:\s*(\d{2}-\d{2}-\d{4})', texto)
        if patron:
            # Convertir de DD-MM-YYYY a DD/MM/YYYY
            fecha = patron.group(1).replace('-', '/')
            return fecha
        return None
    
    def extraer_numero_factura(self, texto: str) -> Optional[str]:
        """Extrae número de factura."""
        # Formato: Número: 0132/25
        patron = re.search(r'Número:\s*(\d+/\d+)', texto)
        if patron:
            return patron.group(1)
        return None
